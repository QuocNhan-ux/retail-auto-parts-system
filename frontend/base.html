<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Autoparts System{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body>
    <nav>
        <div class="nav-container">
            <div class="logo">Auto Parts</div>
            <ul class="nav-links">
                <li><a href="/" class="active">Home</a></li>
                <li><a href="#shop">Shop Parts</a></li>
                <li><a href="#contact">Contact</a></li>

                <!-- Updated cart link -->
                <li><a id="nav-cart" href="/cart/" style="background-color: #ff6600;">Cart (0)</a></li>

                <!-- Sign in / Logout -->
                <li><a id="nav-signin" href="{% url 'customer-login-page' %}">Sign in</a></li>
                <li><a id="nav-logout" href="#" style="display: none;">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer>
        <p><a href="#about">About Us</a></p>
    </footer>

    <!-- Session Script -->
    <script>
    (function () {
        const name = localStorage.getItem('customerName');
        const signinLink = document.getElementById('nav-signin');
        const logoutLink = document.getElementById('nav-logout');
        const cartLink = document.getElementById('nav-cart');

        /* Show "Hi, Name" + Logout */
        if (name) {
            if (signinLink) {
                signinLink.textContent = `Hi, ${name}`;
            }
            if (logoutLink) {
                logoutLink.style.display = 'inline-block';
            }
        }

        /* Load Cart Count on startup */
        if (cartLink) {
            fetch('/api/cart/summary/')
                .then(res => res.ok ? res.json() : Promise.reject())
                .then(data => {
                    if (typeof data.cart_count === 'number') {
                        cartLink.textContent = `Cart (${data.cart_count})`;
                    }
                })
                .catch(() => {});
        }

        /* Logout Handler */
        if (logoutLink) {
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault();

                try {
                    await fetch('/api/auth/customer/logout/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/) || [null, ''])[1],
                            'Content-Type': 'application/json'
                        },
                        body: '{}'
                    });
                } catch (err) {
                    console.error(err);
                }

                // Clear browser state
                localStorage.removeItem('customerName');
                localStorage.removeItem('customerId');

                // Reload
                window.location.href = '/';
            });
        }
    })();
    </script>

</body>
</html>