<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Autoparts System{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body>
    <nav>
        <div class="nav-container">
            <div class="logo">Auto Parts</div>
            <ul class="nav-links">
                <li><a href="/" class="active">Home</a></li>
                <li><a href="/catalog/">Catalog</a></li>

                <!-- Updated cart link -->
                <li><a id="nav-cart" href="/cart/" style="background-color: #ff6600;">Cart (0)</a></li>

                <!-- Sign in / Logout -->
                <li><a id="nav-signin" href="{% url 'customer-history-page' %}">Sign in</a></li>
                <li><a id="nav-logout" href="#" style="display: none;">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer>
        <p><a href="#about">About Us</a></p>
    </footer>

    <!-- Session Script -->
    <script>
    (function () {
        const name = localStorage.getItem('customerName');
        const signinLink = document.getElementById('nav-signin');
        const logoutLink = document.getElementById('nav-logout');
        const cartLink = document.getElementById('nav-cart');
        const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/) || [null, ''])[1];

        /* Show "Hi, Name" + Logout */
        const customerName = localStorage.getItem('customerName');
        const customerId = localStorage.getItem('customerId');

        // If logged in, show greeting and logout button
        if (customerId) {
            if (signinLink) {
                signinLink.textContent = customerName ? `Hi, ${customerName}` : "Hi, Customer";
                signinLink.href = "{% url 'customer-history-page' %}";
            }
            if (logoutLink) {
                logoutLink.style.display = "inline-block";
            }
        } else {
            // If NOT logged in
            if (logoutLink) {
                logoutLink.style.display = "none";
            }
            if (signinLink) {
                signinLink.textContent = "Sign in";
                signinLink.href = "{% url 'customer-login-page' %}";
            }
        }

        /* Update Cart Nav function */
        function updateCartNav(count) {
            if (cartLink && typeof count === 'number') {
                cartLink.textContent = `Cart (${count})`;
            }
        }

        /* Load Cart Count on startup */
        if (cartLink) {
            fetch('/api/cart/summary/')
                .then(res => res.ok ? res.json() : Promise.reject())
                .then(data => {
                    if (typeof data.cart_count === 'number') {
                        updateCartNav(data.cart_count);
                    }
                })
                .catch(() => {});
        }

        /* Add to Cart Handler*/
        document.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.addEventListener('click', async () => {
                const partId = btn.getAttribute('data-product-id') || btn.getAttribute('data-part-id');
                const quantity = parseInt(btn.getAttribute('data-quantity') || '1', 10);

                try {
                    const res = await fetch('/api/cart/add/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify({ part_id: partId, quantity: quantity }),
                    });

                    const data = await res.json();
                    if (res.ok && data.success) {
                        alert('Added to cart!');
                        updateCartNav(data.cart_count);
                    } else if (res.status === 401) {
                        alert('Please sign in before adding items to your cart.');
                        window.location.href = "{% url 'customer-login-page' %}";
                    } else {
                        alert(data.error || 'Could not add to cart.');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Unexpected error adding to cart.');
                }
            });
        });

        /* Logout Handler */
        if (logoutLink) {
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault();

                try {
                    await fetch('/api/auth/customer/logout/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json'
                        },
                        body: '{}'
                    });
                } catch (err) {
                    console.error(err);
                }

                // Clear browser state
                localStorage.removeItem('customerName');
                localStorage.removeItem('customerId');

                // Reload
                window.location.href = '/';
            });
        }
    })();
    </script>

</body>
</html>