{% extends "base.html" %}

{% block title %}Search Results{% endblock %}

{% block content %}
<div class="content-container">

    <h1>Search Results</h1>

    <form method="get" action="{% url 'search_parts' %}" style="margin-bottom: 1.5rem;">
        <input
            type="text"
            name="q"
            placeholder="Search by part name or number..."
            value="{{ query }}"
            class="search-input"
        >
        <button type="submit" class="search-button">Search</button>
    </form>

    {% if query %}
        <p>Showing results for: <strong>{{ query }}</strong></p>
    {% else %}
        <p>Type a part name to search.</p>
    {% endif %}

    {% if parts %}
        <div class="product-grid">
            {% for product in parts %}
                <div class="product-card">
                    <div class="product-image">[Image]</div>
                    <h3>{{ product.name }}</h3>
                    <p class="condition">{{ product.get_condition_display }}</p>
                    <p class="price">${{ product.unit_price }}</p>

                    <button class="add-to-cart"
                            data-part-id="{{ product.part_id }}"
                            data-quantity="1">
                        Add to Cart
                    </button>
                </div>
            {% endfor %}
        </div>
    {% else %}
        {% if query %}
            <p>No parts found matching "<strong>{{ query }}</strong>".</p>
        {% endif %}
    {% endif %}

</div>

<script>
(function () {
    const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/) || [null, ""])[1];
    const cartLink = document.getElementById("nav-cart");

    function updateCartNav(count) {
        if (cartLink && typeof count === "number") {
            cartLink.textContent = `Cart (${count})`;
        }
    }

    async function addToCart(button) {
        const partId = button.dataset.partId;
        const quantity = parseInt(button.dataset.quantity || "1", 10);

        const card = button.closest(".product-card");
        const name = card.querySelector("h3").textContent.trim();
        const priceText = card.querySelector(".price").textContent.replace("$", "").trim();
        const unitPrice = parseFloat(priceText) || 0;

        try {
            const res = await fetch("/api/cart/add/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({
                    part_id: partId,
                    quantity: quantity,
                    name: name,
                    unit_price: unitPrice
                })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                alert("Added to cart!");
                updateCartNav(data.cart_count);
            } else if (res.status === 401) {
                alert("Please sign in before adding items.");
                window.location.href = "{% url 'customer-login-page' %}";
            } else {
                alert(data.error || "Could not add to cart.");
            }
        } catch (err) {
            console.error(err);
            alert("Unexpected error adding to cart.");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".add-to-cart").forEach(btn => {
            btn.addEventListener("click", () => addToCart(btn));
        });
    });
})();
</script>
{% endblock %}