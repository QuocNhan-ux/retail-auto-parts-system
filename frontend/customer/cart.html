{% extends "base.html" %}
{% block title %}Your Cart{% endblock %}

{% block content %}
<section class="cart-page">
    <h1>Your Cart</h1>

    <div id="cart-empty" style="display:none;">
        <p>Your cart is empty.</p>
    </div>

    <table id="cart-table" style="width:100%; border-collapse: collapse; display:none;">
        <thead>
            <tr>
                <th style="text-align:left;">Item</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody id="cart-body"></tbody>
        <tfoot>
            <tr>
                <td colspan="3" style="text-align:right; font-weight:bold;">Total:</td>
                <td id="cart-total" style="font-weight:bold;"></td>
            </tr>
        </tfoot>
    </table>

    <hr>

    <h2>Checkout</h2>
    <form id="checkout-form">
        <label>
            Payment Method:
            <select name="payment_method" required>
                <option value="CREDIT_CARD">Credit Card</option>
                <option value="DEBIT_CARD">Debit Card</option>
                <option value="PAYPAL">PayPal</option>
            </select>
        </label>
        <br><br>
        <label>
            Card Last 4 Digits:
            <input type="text" name="card_last_four_digit" maxlength="4" pattern="\\d{4}" required>
        </label>
        <br><br>
        <button type="submit" class="btn-primary">Confirm & Pay</button>
    </form>

    <p id="checkout-message"></p>
</section>

<script>
(function () {
    const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/) || [null, ''])[1];
    const cartBody = document.getElementById('cart-body');
    const cartTable = document.getElementById('cart-table');
    const cartEmpty = document.getElementById('cart-empty');
    const cartTotal = document.getElementById('cart-total');
    const checkoutForm = document.getElementById('checkout-form');
    const checkoutMsg = document.getElementById('checkout-message');
    const cartLink = document.getElementById('nav-cart');

    let currentItems = []; // [{ part_id, name, unit_price, quantity, subtotal }]

    async function loadCart() {
        const res = await fetch('/api/cart/summary/');
        const data = await res.json();

        currentItems = data.items || [];

        if (!currentItems.length) {
            cartTable.style.display = 'none';
            cartEmpty.style.display = 'block';
            checkoutForm.style.display = 'none';
        } else {
            cartTable.style.display = 'table';
            cartEmpty.style.display = 'none';
            checkoutForm.style.display = 'block';
        }

        cartBody.innerHTML = '';
        currentItems.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.name}</td>
                <td style="text-align:center;">$${item.unit_price}</td>
                <td style="text-align:center;">${item.quantity}</td>
                <td style="text-align:center;">$${item.subtotal}</td>
            `;
            cartBody.appendChild(tr);
        });

        cartTotal.textContent = `$${data.total_amount || '0.00'}`;

        if (cartLink && typeof data.cart_count === 'number') {
            cartLink.textContent = `Cart (${data.cart_count})`;
        }
    }

    // Handle checkout
    checkoutForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!currentItems.length) {
            checkoutMsg.textContent = 'Your cart is empty.';
            return;
        }

        const customerId = localStorage.getItem('customerId');
        if (!customerId) {
            checkoutMsg.textContent = 'Please sign in before checking out.';
            return;
        }

        const formData = new FormData(checkoutForm);
        const payment_method = formData.get('payment_method');
        const card_last_four_digit = formData.get('card_last_four_digit');

        const payload = {
            customer_id: parseInt(customerId, 10),
            store_id: 1,  // change if you support multiple stores
            items: currentItems.map(i => ({
                part_id: i.part_id,
                quantity: i.quantity
            })),
            payment_method,
            card_last_four_digit,
        };

        checkoutMsg.textContent = 'Processing payment...';

        try {
            const res = await fetch('/api/orders/create_order/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify(payload),
            });
            const data = await res.json();

            if (res.ok) {
                checkoutMsg.textContent = 'Order placed successfully! Thank you.';
                // clear cart on server
                await fetch('/api/cart/clear/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                    },
                    body: '{}',
                });
                await loadCart();
            } else {
                checkoutMsg.textContent = data.error || 'Checkout failed. Please try again.';
            }
        } catch (err) {
            console.error(err);
            checkoutMsg.textContent = 'Unexpected error. Please try again.';
        }
    });

    loadCart();
})();
</script>
{% endblock %}