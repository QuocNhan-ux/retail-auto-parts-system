{% extends "base.html" %}

{% block title %}Your Cart - Autoparts System{% endblock %}

{% block content %}
<div class="cart-page">
    <h1>Your Cart</h1>

    <!-- Empty message -->
    <p id="cart-empty-message" style="display:none;">Your cart is empty.</p>

    <!-- Cart table -->
    <table id="cart-table" class="cart-table" style="width:100%; border-collapse:collapse;">
        <thead>
            <tr>
                <th style="text-align:left;">Item</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Line Total</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="cart-table-body"></tbody>
        <tfoot>
            <tr>
                <td colspan="3" style="text-align:right; font-weight:bold;">Total:</td>
                <td id="cart-total">$0.00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <hr>

    <!-- Checkout Section -->
    <h2>Checkout</h2>
    <form id="checkout-form" onsubmit="return false;">
        <label>
            Payment Method:
            <select id="payment-method">
                <option value="CREDIT_CARD">Credit Card</option>
                <option value="DEBIT_CARD">Debit Card</option>
                <option value="PAYPAL">PayPal</option>
            </select>
        </label>
        <br>

        <label>
            Card Last 4 Digits:
            <input id="card-last4" type="text" maxlength="4" />
        </label>
        <br><br>

        <button id="place-order-btn" type="button">Place Order</button>
        <button id="clear-cart-btn" type="button">Clear Cart</button>
    </form>
</div>

<script>
(function () {
    const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/) || [null, ""])[1];

    const cartTableBody = document.getElementById("cart-table-body");
    const cartTotalEl = document.getElementById("cart-total");
    const emptyMessageEl = document.getElementById("cart-empty-message");
    const placeOrderBtn = document.getElementById("place-order-btn");
    const clearCartBtn = document.getElementById("clear-cart-btn");
    const cartLink = document.getElementById("nav-cart");
    const paymentMethodSelect = document.getElementById("payment-method");
    const cardLast4Input = document.getElementById("card-last4");

    function updateCartNav(count) {
        if (cartLink && typeof count === "number") {
            cartLink.textContent = `Cart (${count})`;
        }
    }

    function renderCart(data) {
        cartTableBody.innerHTML = "";

        if (!data.items || data.items.length === 0) {
            emptyMessageEl.style.display = "block";
            cartTotalEl.textContent = "$0.00";
            updateCartNav(0);
            return;
        }

        emptyMessageEl.style.display = "none";

        data.items.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${item.name}</td>
                <td>$${item.unit_price.toFixed(2)}</td>
                <td>${item.quantity}</td>
                <td>$${item.line_total.toFixed(2)}</td>
                <td>
                    <button class="remove-item-btn" data-part-id="${item.part_id}">
                        Remove
                    </button>
                </td>
            `;
            cartTableBody.appendChild(tr);
        });

        cartTotalEl.textContent = `$${data.total.toFixed(2)}`;
        updateCartNav(data.cart_count);
    }

    async function loadCart() {
        try {
            const res = await fetch("/api/cart/summary/");
            if (!res.ok) throw new Error("Failed to load cart");
            const data = await res.json();
            renderCart(data);
        } catch (err) {
            console.error(err);
            emptyMessageEl.textContent = "Could not load cart. Please try again.";
            emptyMessageEl.style.display = "block";
        }
    }

    // Clear cart button
    clearCartBtn.addEventListener("click", async () => {
        try {
            const res = await fetch("/api/cart/clear/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: "{}"
            });
            const data = await res.json();
            if (res.ok && data.success) {
                renderCart({ items: [], total: 0, cart_count: 0 });
            }
        } catch (err) {
            console.error(err);
            alert("Failed to clear cart.");
        }
    });

    // Remove single item
    cartTableBody.addEventListener("click", async (e) => {
        const btn = e.target.closest(".remove-item-btn");
        if (!btn) return;

        const partId = btn.dataset.partId;

        try {
            const res = await fetch("/api/cart/remove/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({ part_id: partId })
            });
            const data = await res.json();
            if (res.ok && data.success) {
                await loadCart();
            }
        } catch (err) {
            console.error(err);
            alert("Failed to remove item.");
        }
    });

    // Place Order
    placeOrderBtn.addEventListener("click", async () => {
        const method = paymentMethodSelect.value;
        const last4 = (cardLast4Input.value || "").trim().slice(-4);

        if (!last4 || last4.length < 4) {
            alert("Please enter the last 4 digits of your card.");
            return;
        }

        try {
            const res = await fetch("/api/cart/checkout/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({
                    payment_method: method,
                    card_last_four_digit: last4
                })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                alert(`Order #${data.order_id} placed successfully! Total: $${data.total.toFixed(2)}`);
                await loadCart();
            } else {
                alert(data.error || "Could not place order.");
            }
        } catch (err) {
            console.error(err);
            alert("Network error while placing order.");
        }
    });

    // Load cart on page load
    loadCart();
})();
</script>

{% endblock %}