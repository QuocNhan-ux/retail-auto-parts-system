{% extends "base.html" %}

{% block title %}Your Cart - Autoparts System{% endblock %}

{% block content %}
<div class="cart-page">
    <h1>Your Cart</h1>
    <p id="cart-message"></p>

    <table id="cart-table" class="cart-table" style="width: 100%; border-collapse: collapse; display: none;">
        <thead>
            <tr>
                <th style="text-align: left;">Item</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Line Total</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="cart-body"></tbody>
        <tfoot>
            <tr>
                <td colspan="3" style="text-align: right; font-weight: bold;">Total:</td>
                <td id="cart-total">$0.00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <hr>

    <h2>Checkout</h2>
    <form id="checkout-form">
        <label>
            Payment Method
            <select name="payment_method">
                <option value="CREDIT_CARD">Credit Card</option>
                <option value="DEBIT_CARD">Debit Card</option>
                <option value="PAYPAL">PayPal</option>
            </select>
        </label>
        <br>
        <label>
            Card Last 4 Digits
            <input type="text" name="card_last4" maxlength="4" />
        </label>
        <br><br>
        <button type="submit">Place Order</button>
        <button type="button" id="btn-clear-cart">Clear Cart</button>
    </form>
</div>

<script>
(function () {
    const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/) || [null, ""])[1];

    const cartTable = document.getElementById("cart-table");
    const cartBody = document.getElementById("cart-body");
    const cartTotalEl = document.getElementById("cart-total");
    const cartMessage = document.getElementById("cart-message");
    const cartLink = document.getElementById("nav-cart");

    function updateNav(count) {
        if (cartLink && typeof count === "number") {
            cartLink.textContent = `Cart (${count})`;
        }
    }

    function renderCart(data) {
        const items = data.items || [];
        const count = data.cart_count || 0;
        const total = data.total || 0;

        updateNav(count);

        if (!items.length) {
            cartTable.style.display = "none";
            cartMessage.textContent = "Your cart is empty.";
            cartTotalEl.textContent = "$0.00";
            return;
        }

        cartTable.style.display = "table";
        cartMessage.textContent = "";

        cartBody.innerHTML = "";
        items.forEach(item => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${item.name}</td>
                <td style="text-align: center;">$${item.unit_price.toFixed(2)}</td>
                <td style="text-align: center;">${item.quantity}</td>
                <td style="text-align: center;">$${item.line_total.toFixed(2)}</td>
                <td style="text-align: center;">
                    <button type="button" class="btn-remove-item" data-part-id="${item.part_id}">
                        Remove
                    </button>
                </td>
            `;

            cartBody.appendChild(tr);
        });

        cartTotalEl.textContent = `$${total.toFixed(2)}`;
    }

    async function loadCart() {
        try {
            const res = await fetch("/api/cart/summary/");
            if (!res.ok) throw new Error("bad status");
            const data = await res.json();
            renderCart(data);
        } catch (err) {
            console.error(err);
            cartMessage.textContent = "Could not load cart. Please try again.";
            cartTable.style.display = "none";
        }
    }

    async function clearCart() {
        try {
            const res = await fetch("/api/cart/clear/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: "{}"
            });
            const data = await res.json();
            if (res.ok && data.success) {
                renderCart({ items: [], cart_count: 0, total: 0 });
            }
        } catch (err) {
            console.error(err);
        }
    }

    async function removeItem(partId) {
        try {
            const res = await fetch("/api/cart/remove/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({ part_id: partId })
            });
            const data = await res.json();
            if (res.ok && data.success) {
                // reload cart from backend to get fresh totals
                await loadCart();
            }
        } catch (err) {
            console.error(err);
        }
    }

    document.addEventListener("click", (e) => {
        if (e.target.classList.contains("btn-remove-item")) {
            const partId = e.target.getAttribute("data-part-id");
            removeItem(partId);
        }
    });

    document.getElementById("btn-clear-cart").addEventListener("click", (e) => {
        e.preventDefault();
        clearCart();
    });

    document.getElementById("checkout-form").addEventListener("submit", (e) => {
        e.preventDefault();
        // You can plug this into your create_order API later.
        alert("Checkout flow not fully wired yet, but cart + totals are working.");
    });

    // initial load
    loadCart();
})();
</script>
{% endblock %}