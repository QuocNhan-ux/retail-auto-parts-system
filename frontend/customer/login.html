{% extends "base.html" %}

{% block title %}Customer Login - Autoparts System{% endblock %}

{% block content %}
<div class="auth-container">
    <h1>Customer Login</h1>
    <form id="customer-login-form">
        <div class="form-group">
            <label for="username">Username</label>
            <input id="username" name="username" type="text" required>
        </div>

        <div class="form-group">
            <label for="password">Password</label>
            <input id="password" name="password" type="password" required>
        </div>

        <button type="submit">Sign In</button>
    </form>

    <div id="login-message" class="message"></div>
</div>

<div style="margin-top: 20px;">
    <a href="/employee/login/" 
       style="
            font-size: 14px;
            padding: 6px 12px;
            border: 1px solid #333;
            background: #f0f0f0;
            text-decoration: none;
            border-radius: 4px;
        ">
        Employee Sign In
    </a>
</div>

<script>
document.getElementById('customer-login-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const username = (document.getElementById('username').value || '').trim();
    const password = document.getElementById('password').value;

    const message = document.getElementById('login-message');
    message.textContent = 'Signing in...';

    try {
        const response = await fetch('/api/auth/customer/login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/) || [null, ''])[1]
            },
            body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // Save who is logged in (for later use)
            localStorage.setItem('customerId', data.customer_id);
            localStorage.setItem('customerName', data.full_name);

            message.textContent = `Welcome, ${data.full_name}! (Customer #${data.customer_id})`;

            // Go to home page (or wherever you want)
            setTimeout(() => {
                window.location.href = '/';
            }, 700);

        } else {
            message.textContent = data.error || 'Login failed. Please try again.';
        }
    } catch (err) {
        console.error(err);
        message.textContent = 'Unexpected error. Please try again later.';
    }
});
</script>
{% endblock %}